<?xml version="1.0"?>  

<!-- c182s fuel system according to POH 7-25
The left and right wing are connected to the fuel selector valve. both tanks have a drain valve.
The fuel selector has a small fuel sump which is fed from the selected tanks using gravity.
From there the fuel flows to a strainer (also with small sump) and to the electrical aux pump
and then to the mechanical (enginge driven) pump which pumps it to the fuel/air control unit.
At the fuel/air unit sits the fuel flow meter. From there the fuel is delivered to the engines
intake manifods.

Implementation notice:
- The idea is to treat every item that holds fuel as independent tank.
- The tanks have drains: /controls/fuel/tank[n]/drain-valve (1=open/0=shut)
- Switches define possible valves and define the ammount and conditions of flow.
- Summers define the outflow/inflow of the whole tank and depend on linked valves;
  they are just there to let jsbsim handle the content ammount. This way a tank can
  simultaneously be drained+refuelled+whatever.
- internal system flow rate s synchronized to 0.5pps for now.
-->
<system name="fuel">
    
    <property type="bool" value="0">/controls/fuel/tank[0]/drain-valve</property>
    <property type="bool" value="0">/controls/fuel/tank[1]/drain-valve</property>
    <property type="bool" value="0">/controls/fuel/tank[2]/drain-valve</property>
    <property type="bool" value="0">/controls/fuel/tank[3]/drain-valve</property>
    
    <property type="double" value="0">fuel/fuel-selector-sump-drain-flow-rate-pps</property>
    <property type="double" value="0">fuel/fuel-strainer-sump-drain-flow-rate-pps</property>
    <property type="double" value="0">flow-left-right-transfer-calculated-pps</property>
    <property type="double" value="0">fuel/flow-left-right-transfer-calculated-pps</property>
    
    <property type="bool" value="1">/systems/fuel/fuel-pump-aux-serviceable</property>
    <property type="bool" value="1">/systems/fuel/fuel-pump-engine-serviceable</property>
    <property type="bool" value="1">/systems/fuel/fuel-pipe-serviceable</property>
    <property type="double" value="0">/systems/fuel/tank[0]/leak-flow-rate-pps</property>
    <property type="double" value="0">/systems/fuel/tank[1]/leak-flow-rate-pps</property>
    <property type="double" value="0">/systems/fuel/tank[2]/leak-flow-rate-pps</property>
    <property type="double" value="0">/systems/fuel/tank[3]/leak-flow-rate-pps</property>
    <property type="double" value="0">/systems/fuel/tank[4]/leak-flow-rate-pps</property> <!-- currently implicitely set via fuel-pipe-serviceable -->
    <property type="double" value="0">/systems/fuel/tank[5]/leak-flow-rate-pps</property>
    
    <property type="double" value="0">/systems/fuel/priming-mixture-flow</property>
    <property type="bool" value="0">/systems/fuel/engine-flooded</property>

    
    <channel name="fuel-system">
        <!-- property: /fdm/jsbsim/propulsion/tank[n]/external-flow-rate-pps -->
       
        
        <!-- ######################### -->
        <!-- ###### 0: LEFT TANK ##### -->
        <!-- ######################### -->
        <switch name="fuel/left-tank-drain-flow-rate-pps">
            <default value="0"/>
            <test logic="AND" value="25">
                /controls/fuel/tank[0]/drain-valve EQ 1
            </test>
        </switch>
        <switch name="fuel/left-tank-tofuelselector-flow-rate-pps">
            <default value="0"/>
  
            <!-- lower drain open? -->
            <test logic="AND" value="fuel/fuel-selector-sump-drain-flow-rate-pps">
                <switch logic="AND">
                    /fdm/jsbsim/propulsion/tank[0]/pct-full     GT    0.0
                    /fdm/jsbsim/propulsion/tank[2]/pct-full     LT   90.0
                    fuel/fuel-selector-sump-drain-flow-rate-pps GT    0
                </switch>
                <switch logic="OR">
                    /controls/switches/fuel_tank_selector EQ 3
                    /controls/switches/fuel_tank_selector EQ 2
                </switch>
            </test>
            <test logic="AND" value="fuel/fuel-strainer-sump-drain-flow-rate-pps">
                <switch logic="AND">
                    /fdm/jsbsim/propulsion/tank[0]/pct-full     GT    0.0
                    /fdm/jsbsim/propulsion/tank[2]/pct-full     LT   90.0
                    fuel/fuel-strainer-sump-drain-flow-rate-pps GT    0
                </switch>
                <switch logic="OR">
                    /controls/switches/fuel_tank_selector EQ 3
                    /controls/switches/fuel_tank_selector EQ 2
                </switch>
            </test>
            
            <!-- normal operation -->
            <test logic="AND" value="0.5"> <!-- left selected -->
                /controls/switches/fuel_tank_selector EQ 3
                /fdm/jsbsim/propulsion/tank[0]/pct-full  GT    0.0
                /fdm/jsbsim/propulsion/tank[2]/pct-full  LT  90.0
            </test>
            <test logic="AND" value="0.25"> <!-- both selected -->
                /controls/switches/fuel_tank_selector EQ 2
                /fdm/jsbsim/propulsion/tank[0]/pct-full  GT    0.0
                /fdm/jsbsim/propulsion/tank[2]/pct-full  LT  90.0
            </test>
        </switch>
 
        <summer name="fuel/left-wing-total-flow-pps">
            <input>-fuel/left-tank-drain-flow-rate-pps</input>
            <input>-/systems/fuel/tank[0]/leak-flow-rate-pps</input>
            <input>-fuel/flow-left-right-transfer-pps</input>
            <input>-fuel/left-tank-tofuelselector-flow-rate-pps</input>
            <output>/fdm/jsbsim/propulsion/tank[0]/external-flow-rate-pps</output>
        </summer>
        
        
        
        
        <!-- ########################## -->
        <!-- ###### 1: RIGHT TANK ##### -->
        <!-- ########################## -->
        <switch name="fuel/right-tank-drain-flow-rate-pps">
            <default value="0"/>
            <test logic="AND" value="25">
                /controls/fuel/tank[1]/drain-valve EQ 1
            </test>
        </switch>
        <switch name="fuel/right-tank-tofuelselector-flow-rate-pps">
            <default value="0"/>
            
            <!-- lower drain open? -->
            <test logic="AND" value="fuel/fuel-selector-sump-drain-flow-rate-pps">
                <switch logic="AND">
                    /fdm/jsbsim/propulsion/tank[1]/pct-full     GT   0.0
                    /fdm/jsbsim/propulsion/tank[2]/pct-full     LT  90.0
                    fuel/fuel-selector-sump-drain-flow-rate-pps GT   0
                </switch>
                <switch logic="OR">
                    /controls/switches/fuel_tank_selector EQ 1
                    /controls/switches/fuel_tank_selector EQ 2
                </switch>
            </test>
            <test logic="AND" value="fuel/fuel-strainer-sump-drain-flow-rate-pps">
                <switch logic="AND">
                    /fdm/jsbsim/propulsion/tank[1]/pct-full     GT   0.0
                    /fdm/jsbsim/propulsion/tank[2]/pct-full     LT  90.0
                    fuel/fuel-strainer-sump-drain-flow-rate-pps GT   0
                </switch>
                <switch logic="OR">
                    /controls/switches/fuel_tank_selector EQ 1
                    /controls/switches/fuel_tank_selector EQ 2
                </switch>
            </test>
            
            <!-- normal operation -->
            <test logic="AND" value="0.5"> <!-- right selected -->
                /controls/switches/fuel_tank_selector EQ 1
                /fdm/jsbsim/propulsion/tank[1]/pct-full  GT    0.0
                /fdm/jsbsim/propulsion/tank[2]/pct-full  LT  90.0
            </test>
            <test logic="AND" value="0.25"> <!-- both selected -->
                /controls/switches/fuel_tank_selector EQ 2
                /fdm/jsbsim/propulsion/tank[1]/pct-full  GT    0.0
                /fdm/jsbsim/propulsion/tank[2]/pct-full  LT  90.0
            </test>
        </switch>
        
        <summer name="fuel/right-wing-total-flow-pps">
            <input>-fuel/right-tank-drain-flow-rate-pps</input>
            <input>-/systems/fuel/tank[1]/leak-flow-rate-pps</input>
            <input>-fuel/right-tank-tofuelselector-flow-rate-pps</input>
            <input>fuel/flow-left-right-transfer-pps</input>
            <output>/fdm/jsbsim/propulsion/tank[1]/external-flow-rate-pps</output>
        </summer>
        
        
        
        
        <!-- TRANSFER BETWEEN TANKS -->
        <!-- when the fuel selection lever is BOTH, the tanks should slowly level out. -->
        <!-- TODO: TAKE POSITION AND GRAVITY INTO ACCOUNT!!! When the plane stands uneven, one tank may become more filled than the other! -->
        <!-- TODO: flow rate of 1pps is arbitary! -->
        <switch name="fuel/flow-left-right-transfer-pps">
            <default value="0"/>
            <test logic="AND" value="fuel/flow-left-right-transfer-calculated-pps">
                /fdm/jsbsim/propulsion/tank[0]/pct-full GT 1.0
                /fdm/jsbsim/propulsion/tank[0]/pct-full GT /fdm/jsbsim/propulsion/tank[1]/pct-full
                /fdm/jsbsim/propulsion/tank[1]/pct-full LT 99.0
                /controls/switches/fuel_tank_selector EQ 2
            </test>
            <test logic="AND" value="fuel/flow-left-right-transfer-calculated-pps">
                /fdm/jsbsim/propulsion/tank[1]/pct-full GT 1.0
                /fdm/jsbsim/propulsion/tank[1]/pct-full GT /fdm/jsbsim/propulsion/tank[0]/pct-full
                /fdm/jsbsim/propulsion/tank[0]/pct-full LT 99.0
                /controls/switches/fuel_tank_selector EQ 2
            </test>
        </switch>
        
        
        <fcs_function name="fuel/flow-left-right-transfer-tanks-difference">
            <function>
                <difference>
                    <property>/fdm/jsbsim/propulsion/tank[0]/pct-full</property>
                    <property>/fdm/jsbsim/propulsion/tank[1]/pct-full</property>
                </difference>
            </function>
            <output>fuel/flow-left-right-transfer-tanks-difference</output>   
        </fcs_function>
        
        <fcs_function name="fuel/flow-left-right-transfer-calculated-pps">
            <function>
                <table>
                    <independentVar lookup="row">fuel/flow-left-right-transfer-tanks-difference</independentVar>
                    <tableData>
                        -10.0   -0.5
                         -3.0   -0.5
                         -2.5    0.0
                          0.0    0.0
                          2.5    0.0
                          3.0    0.5
                         10.0    0.5
                    </tableData>
                </table>
            </function>
            <output>fuel/flow-left-right-transfer-calculated-pps</output>   
        </fcs_function>
        
        
        <!-- ################################# -->
        <!-- ##### 2: FUEL SELECTOR SUMP ##### -->
        <!-- ################################# -->
        <!-- fuel selector position: 0=off, 1=right, 2=both, 3=left (/controls/switches/fuel_tank_selector) -->
        <switch name="fuel/fuel-selector-sump-drain-flow-rate-pps">
            <default value="0"/>
            <test logic="AND" value="25">
                /controls/fuel/tank[2]/drain-valve EQ 1
            </test>
        </switch>
        <switch name="fuel/fuel-selector-tofuelstrainer-flow-rate-pps">
            <default value="0"/>
            
            <!-- lower drain open? -->
            <test logic="AND" value="fuel/fuel-strainer-sump-drain-flow-rate-pps">
                /fdm/jsbsim/propulsion/tank[2]/pct-full     GT   0.0
                /fdm/jsbsim/propulsion/tank[3]/pct-full     LT  90.0
                fuel/fuel-strainer-sump-drain-flow-rate-pps GT   0
            </test>
            
            <!-- normal operation -->
            <test logic="AND" value="0.5">
                /fdm/jsbsim/propulsion/tank[2]/pct-full  GT  10.0
                /fdm/jsbsim/propulsion/tank[3]/pct-full  LT  90.0
            </test>
        </switch>
        
        <summer name="fuel/fuel-selector-total-flow-pps">
            <input>fuel/left-tank-tofuelselector-flow-rate-pps</input>
            <input>fuel/right-tank-tofuelselector-flow-rate-pps</input>
            <input>-fuel/fuel-selector-tofuelstrainer-flow-rate-pps</input>
            <input>-fuel/fuel-selector-sump-drain-flow-rate-pps</input>
            <input>-/systems/fuel/tank[2]/leak-flow-rate-pps</input>
            <output>/fdm/jsbsim/propulsion/tank[2]/external-flow-rate-pps</output>
        </summer>

        
        
        
        <!-- ################################# -->
        <!-- ##### 3: FUEL STRAINER SUMP ##### -->
        <!-- ################################# -->
        <switch name="fuel/fuel-strainer-sump-drain-flow-rate-pps">
            <default value="0"/>
            <test logic="AND" value="25">
                /controls/fuel/tank[3]/drain-valve EQ  1
            </test>
        </switch>
        <switch name="fuel/fuel-strainer-tofuelpipe-flow-rate-pps">
            <default value="0"/>
            <!-- TODO: insert leakage of fuel pipe code here -->
            <test logic="AND" value="0.5">
                /fdm/jsbsim/propulsion/tank[3]/pct-full  GT  10.0
                /fdm/jsbsim/propulsion/tank[4]/pct-full  LT  90.0
                accelerations/Nz GE -0.5
            </test>
        </switch>
        
        <summer name="fuel/fuel-strainer-total-flow-pps">
            <input>fuel/fuel-selector-tofuelstrainer-flow-rate-pps</input>
            <input>-fuel/fuel-strainer-tofuelpipe-flow-rate-pps</input>
            <input>-fuel/fuel-strainer-sump-drain-flow-rate-pps</input>
            <input>-/systems/fuel/tank[3]/leak-flow-rate-pps</input>
            <output>/fdm/jsbsim/propulsion/tank[3]/external-flow-rate-pps</output>
        </summer>

        
        
        <!-- ####################### -->
        <!-- ##### 4: FUEL PIPE #### -->
        <!-- ####################### -->
        <!-- When not serviceable (i.e. broken), a leakage will occur and no fuel can be pumped -->
        <switch name="/systems/fuel/tank[4]/leak-flow-rate-pps">
            <default value="0"/>
            <test logic="AND" value="5">   <!-- limited by the flow rates of preceeding tanks -->
                /systems/fuel/fuel-pipe-serviceable EQ 0
            </test>
        </switch>
        <summer name="fuel/fuel-pipe-total-flow-pps">
            <input>-/systems/fuel/tank[4]/leak-flow-rate-pps</input>
            <input>fuel/fuel-strainer-tofuelpipe-flow-rate-pps</input>
            <input>-fuel/pump-flow-rate-pps</input>
            <output>/fdm/jsbsim/propulsion/tank[4]/external-flow-rate-pps</output>
        </summer>
        
            
            
        <!-- ####################### -->
        <!-- ##### FUEL PUMPING #### -->
        <!-- ####################### -->
        <!-- The fuel pumps fill the manifold from the fuel pipe. Fill rate >= treshold means engine flooded. -->
        <switch name="fuel/pump-flow-rate-pps">
            <default value="0"/>
            
            <!-- fuel pipe broken? no fuel to manifold! -->
            <test logic="AND" value="0">
                /systems/fuel/fuel-pipe-serviceable  EQ  0
            </test>
            
            <!-- Engine on: mechanical pump OR aux pump active -->
            <test logic="AND" value="0.5">
                <test logic="AND">
                    <!-- engine running and fuel flow possible -->
                    /fdm/jsbsim/propulsion/engine/set-running  EQ   1
                    /fdm/jsbsim/propulsion/tank[4]/pct-full    GT  10.0
                    /fdm/jsbsim/propulsion/tank[5]/pct-full    LT  30.0
                </test>
                <test logic="OR">
                    <test logic="AND">
                        <!-- motor pump is serviceable -->
                        /systems/fuel/fuel-pump-engine-serviceable EQ   1
                    </test>
                    <test logic="AND">
                        <!-- motor pump failed but aux pump is switched on and serviceable -->
                        /systems/electrical/outputs/fuel-pump      GT   0
                        /systems/fuel/fuel-pump-aux-serviceable    EQ   1
                    </test>
                </test>
            </test>
            
            <!-- Engine off: Priming mode -->
            <test logic="AND" value="/systems/fuel/priming-mixture-flow">
                <!-- engine off: aux pump on and powered? -->
                /fdm/jsbsim/propulsion/engine/set-running  EQ   0
                /systems/electrical/outputs/fuel-pump      GT   0
                /systems/fuel/fuel-pump-aux-serviceable    EQ   1
                /fdm/jsbsim/propulsion/tank[4]/pct-full    GT  10.0
                /fdm/jsbsim/propulsion/tank[5]/pct-full    LT 100.0
            </test>
        </switch>

         
        
        <!-- ###################### -->
        <!-- ##### 5: MANIFOLD #### -->
        <!-- Engine sucks here (max=0.035pps). The only inflow can come from an active pump. -->
        <!-- Special is also, that the mechanical pump can only fill this tank to the flood-threshold. -->
        <!-- The electrical pump can fill it fully; whereas a threshold signals "engine flooded" -->
        <switch name="fuel/manifold-dissipate-rate-pps">
            <!-- fuel evaporates slowly when engine not running -->
            <!-- TODO: crunch numbers: this should result in a "primed engeine" after 20-30 minutes after "normal" engine shutdown! -->
            <default value="0"/>
            <test logic="AND" value="0.0000225"> <!-- about 0.5p in 30 min -->
                /fdm/jsbsim/propulsion/engine/set-running  EQ   0
                /systems/electrical/outputs/fuel-pump      EQ   0
            </test>
        </switch>
        <summer name="fuel/manifold-total-flow-pps">
            <input>fuel/pump-flow-rate-pps</input>
            <input>-/systems/fuel/tank[5]/leak-flow-rate-pps</input>
            <input>-fuel/manifold-dissipate-rate-pps</input>
            <!--    <input>-/fdm/jsbsim/propulsion/engine/fuel-flow-rate-pps</input>   NOT NECESSARY: engine sucks already (see feed command) -->
            <output>/fdm/jsbsim/propulsion/tank[5]/external-flow-rate-pps</output>
        </summer>
    
        
        
        <!-- ########################## -->
        <!-- #  Priming stuff         # -->
        <!-- ########################## -->
        
        <!-- Engine flooded indicator -->
        <switch name="/systems/fuel/engine-flooded">
            <default value="0"/>
            <test logic="AND" value="1">
                /fdm/jsbsim/propulsion/tank[5]/pct-full  GT  75.0
            </test>
        </switch>
        
        
        <!-- Calculates the priming flow depending on selected mixture -->
        <!-- TODO: should be some "bell courve": fuel flow is slow at first until pressure is OK. This should be somewhere at the sweet spot (3-5 seconds after mix=100% at throt=1/4 inch) and show 6 gal/Hr (36.12 lbs = 0.010pps) on the flow gauge (see: https://www.youtube.com/watch?v=-yVMskFQZsw&t=193s ) -->
        <!-- Throttle also plays a role (should be open 1/4 inch - how much % is that?) -->
        <pure_gain name="/systems/fuel/priming-mixture-flow">
            <input> /controls/engines/engine/mixture </input>
            <gain> 0.010 </gain>
        </pure_gain>

        
        
    </channel>

</system>
